<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SafkaShare</title>
    <link href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAAeJ2nACRBbwB3hnUAC06fADVrdwAUi/EAKbT2AAFrpQAAVskAOmjrAAAkWQAcSEYABlfDAFiZZwALsPQAFXnXACik0AACZ8YAAGrGAAdClwAWYq4ADFCCAEp6dwARarQAD5TgACAxkQAPlOkAAAATAHGssQBQgdwAfoB/ACtFcwAbb7oAHpHgABF0yQCChXMADH/PAA9WTQAMHkgABV27AChpwwADN0IAFCE/ABhllABR0fMAFH7eACA8awAkKiQAG4fVAAxCoQAbZ6wABlaVAElgTwBGeJYAMo9DABBbiQAOTacAUfP2AAQAFAAPT6QAVlleAFHdxwAfVIYAGTRmAAwdRgAWdc0AsNrOAD9EcQALY8UAVYGxACulLAAPVoQAE1KBACBxlQANTZYABHXXABBSkwA2bdkAFKbiAARfugB9o8UAO5ivAC6bygAinCQAO3mAAICkyAAahcgAG37XAG6iqAAJVIgASX93ACeo6AAqRFgAttHqAAA+YgAAM3cACpH1ACtRtABJVGwAHbr6AGFpfQAKeckAgoZ5AByn1AAVfs8APnuQAA2S3gAAUrAAGpDYAEd3nwAWZMoACAAOABlQjwB6n8QAs8nLAITAhQADCB0ACIfZABRWswAKQooAQPLuABZmQgCu0ewABmTLABiB2QANZr8ACUWcAAdPlgCfydUAQHxEAB5jtgALNW0ADZvxABy+/wANbOMAFHnUAD51gAAmqNAAFGClAEBYTgABZc8AB2bAAAdjyQAEZ8wAEQ0tAAkSPAALl+8AGREeABVpyQANqe8APGmKACh3ogAdnOMArODKACuBpQALX9AAtNLoAERxmQASZsEAFEaPADxjggAGABEAFk+YADxofwAWl/kAF3DWAIWcvgAZWZsAOE1uAAxHgQAYRG8AAjpSAAdmywAeetkACWfFABNDhwALZcgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHMBl0lIgDOhWYEAAAAAAEQaYqg4FloVV1ObBQAAAKkLhJKRO6JwlCtAmEqkAABBJxwwNYw9ZRcdUmovAgAAdYlbglRHNzqKEWhPLV0AZwx5PnomX2AEMilOCh5jJANVLHg0CCWHrTFvnHx/IB90KhRFI0xhGw+GmVwTlauaDqx3rhIGpZNrhRlkIrE/QwA2OY8oiEKvLn12lgdsRgAAnaCDjlAQjaaQaW1mo14AAAB7sEshfg0JWBiLcQAAAAAAAABRbqo8n02epwAAAAAAAAAAAAAAVnIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AADgBwAAwAMAAIABAACAAQAAgAEAAAAAAAAAAAAAAAAAAAAAAACAAQAAgAEAAMAHAADwDwAA/n8AAP//AAA=" rel="icon" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Karla:400,700|Roboto" rel="stylesheet">
    <link href="plugins/material/css/materialdesignicons.min.css" rel="stylesheet" />
    <link id="main-css-href" rel="stylesheet" href="css/style.css" />
    <style>
        .responsive-image {
            width: 100%;
            max-width: 200px; 
            height: auto; 
            display: block; 
            margin: 0 auto; 
        }
        </style>
</head>
<body class="navbar-fixed sidebar-fixed" id="body">

    <div class="wrapper">
        <aside class="left-sidebar sidebar-dark" id="left-sidebar">
            <div id="sidebar" class="sidebar sidebar-with-footer">
                <div class="app-brand">
                    <a href="/index.html">
                        <img src="images/logo.png" alt="Mono">
                    </a>
                </div>
                <div class="sidebar-left"  style="height: 100%;">
                    <ul class="nav sidebar-inner" id="sidebar-menu">
                        <li>
                            <a class="sidenav-item-link" href="index.html">
                                <i class="mdi mdi-briefcase-account-outline"></i>
                                <span class="nav-text">Etusivu</span>
                            </a>
                        </li>
                        <li>
                            <a class="sidenav-item-link" href="recipe-list.html">
                                <i class="mdi mdi-food-variant"></i>
                                <span class="nav-text">Hae reseptejä</span>
                            </a>
                        </li>
                        <li>
                            <a class="sidenav-item-link" href="user-recipes.html">
                              <i class="mdi mdi-food-apple"></i>
                              <span class="nav-text">Omat reseptit</span>
                            </a>
                          </li>
                    </ul>
                </div>
            </div>
        </aside>
        <div class="page-wrapper">
            <header class="main-header" id="header">
                <nav class="navbar navbar-expand-lg navbar-light" id="navbar">
                    <button id="sidebar-toggler" class="sidebar-toggle">
                        <span class="sr-only">Toggle navigation</span>
                    </button>
            
                    <div class="navbar-right">
                        <ul class="nav navbar-nav">
                            <button class="button nav-link" style="visibility: hidden;" id="logoutButton" disabled="true">Kirjaudu ulos</button>
                            <button class="button nav-link" id="loginButton">
                                <span class="d-none d-lg-inline-block" id="userLabel">Kirjaudu sisään</span>

                            </button>
                        </ul>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
        
                                var storedName = sessionStorage.getItem('full_name');
                                // Check if data exists
                                if (storedName) {
                                  // Display the retrieved data on the page
                                  document.getElementById('loginButton').disabled = true;
                                  document.getElementById('loginButton').style="color: black;";
                                  document.getElementById('logoutButton').disabled = false;
                                  document.getElementById('logoutButton').style="visibility: visible; color: red;";
                                  document.getElementById('userLabel').textContent = storedName;
                                } else {
                                  // If no data found in local storage
                                  document.getElementById('loginButton').disabled = false;
                                  document.getElementById('logoutButton').disabled = true;
                                  document.getElementById('logoutButton').style="visibility: hidden;";
                                  document.getElementById('userLabel').textContent = "Kirjaudu sisään";
                                }
                                const loginButton = document.getElementById('loginButton');
                                loginButton.addEventListener('click', function() {
                                    window.location.href = 'login.html';
                                });
                                const logoutButton = document.getElementById('logoutButton');
                                logoutButton.addEventListener('click', function() {
                                  sessionStorage.clear();
                                    window.location.href = 'index.html';
                                });
                                const omatReseptitButton = document.getElementById('omatReseptit');
                                omatReseptitButton.addEventListener('click', function() {
                                  var storedName = sessionStorage.getItem('full_name');
                                  if (storedName) {
                                    window.location.href = 'user-recipes.html';
                                  } else {
                                    window.location.href = 'login.html';
                                  }
                                    
                                });
                            });
                            </script>
                    </div>
                </nav>
            </header>

            <div class="container mt-5">
                <div class="row">
                    <div class="col-6">
                        <button onclick="history.back()" class="btn btn-light btn-sm">
                            <i class="mdi mdi-arrow-left"></i> Siirry takaisin
                        </button>
                    </div>
                </div>
                <div id="recipe-detail">¨
                </div>
          
            <div class="mt-1">
                <h2>Write a Review</h2>
                <form id="reviewForm">
                    <div class="form-group">
                        <label for="rating">Arvosana</label>
                        <input type="text" class="form-control" id="rating" required>
                    </div>
                    <div class="form-group">
                        <label for="comment">Kommentti</label>
                        <textarea class="form-control" id="comment" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Syötä arvostelu</button>
                </form>
            </div>

            <!-- Reviews Display Section -->
            <div id="reviewsSection" class="mt-4">
                <h2>Reviews</h2>
                <!-- Individual reviews will be inserted here -->
            </div>
        </div>
    </div>  
</div>
</div>
        <script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch Recipe Detail
    async function fetchRecipeDetail() {
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('_id');
        
        try {
            const response = await fetch(`https://funny-cuchufli-a98cc3.netlify.app/.netlify/functions/reseptit?id=${recipeId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch recipe details');
            }
            const recipe = await response.json();
            displayRecipeDetail(recipe);
        } catch (error) {
            console.error('Error fetching recipe details:', error);
        }
    }

    async function displayRecipeDetail(recipe) {
    const detailContainer = document.getElementById('recipe-detail');
    const title = recipe.title;
    document.title = `${title} - SafkaShare`;
    const imageUrl = recipe.image_url || 'fallback-image-url.jpg';
    const ingredientsFormatted = recipe.ingredients.split(',').join('<br>');

    try {
        const response = await fetch(`https://funny-cuchufli-a98cc3.netlify.app/.netlify/functions/GetUserName?id=${recipe.user_id}`);
        if (!response.ok) {
            throw new Error('Error fetching user name');
        }
        const userData = await response.json();
        const creator = userData.full_name;

        detailContainer.innerHTML = `
            <div class="card">
                <img src="${imageUrl}" class="card-img-top responsive-image" alt="${title}">
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <p class="card-text">Ainesosat:<br>${ingredientsFormatted}</p>
                    <p class="card-text">Ohjeet:<br>${recipe.instructions}</p>
                    <p class="card-text">Avainsanat:<br>${recipe.keywords}</p>
                    <p class="card-text">Tekijä:<br>${creator}</p>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error fetching user name:', error);
        // Fallback if user name fetching fails
        detailContainer.innerHTML = `
            <div class="card">
                <img src="${imageUrl}" class="card-img-top responsive-image" alt="${title}">
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <p class="card-text">Ainesosat:<br>${ingredientsFormatted}</p>
                    <p class="card-text">Ohjeet:<br>${recipe.instructions}</p>
                    <p class="card-text">Avainsanat:<br>${recipe.keywords}</p>
                    <p class="card-text">Luoja: <br>SafkaShare</p>
                </div>
            </div>
        `;
    }
}
// Fetch and Display Reviews
async function fetchAndDisplayReviews() {
    const urlParams = new URLSearchParams(window.location.search);
    const recipeId = urlParams.get('_id');

    try {
        const response = await fetch(`https://funny-cuchufli-a98cc3.netlify.app/.netlify/functions/AddReview`);
        if (!response.ok) {
            throw new Error('Failed to fetch reviews');
        }
        const reviews = await response.json();
        const reviewsContainer = document.getElementById('reviewsSection');
        reviewsContainer.innerHTML = '<h2>Arvostelut</h2>';

        let reviewsFound = false;
        for (const review of reviews) {
            if (review.recipe_id === recipeId) {
                let stars = '';
                for (let i = 0; i < 5; i++) {
                    stars += i < review.rating ? '★' : '☆';
                }
                // Fetch user details based on user_id
                const userResponse = await fetch(`https://funny-cuchufli-a98cc3.netlify.app/.netlify/functions/GetUserName?user_id=${review.user_id}`);
                if (!userResponse.ok) {
                    throw new Error('Failed to fetch user details');
                }
                const userData = await userResponse.json();
                const user = userData.find(user => user._id === review.user_id); // Finding the user by user_id
                const userLabel = user ? user.full_name : 'Unknown'; // Accessing full_name if user found
                reviewsContainer.innerHTML += `
                    <div class="review mb-4">
                        <p><strong>Arvostelija:</strong> ${userLabel}</p>
                        <p>Arvosana: ${stars}</p>
                        <p>Kommentti: ${review.comment}</p>
                    </div>
                `;
                reviewsFound = true;
            }
        }
        if (!reviewsFound) {
            reviewsContainer.innerHTML += '<p>Ei arvosteluja vielä.</p>';
        }
    } catch (error) {
        console.error('Error fetching reviews:', error);
        document.getElementById('reviewsSection').innerHTML = `Error fetching reviews: ${error.message}`;
    }
}

// Submit Review
// Submit Review
document.getElementById('reviewForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const rating = document.getElementById('rating').value;
    const comment = document.getElementById('comment').value;
    const urlParams = new URLSearchParams(window.location.search);
    const recipeId = urlParams.get('_id');
    
    // Retrieve userId from session storage
    const userId = sessionStorage.getItem('userId');
    console.log('Retrieved user ID from session:', userId);
    
    // Check if userId is retrieved successfully
    if (!userId) {
        console.error('User ID not found in session storage');
        return; // Exit the function if userId is not found
    }
    
    // Create the reviewData object
    const reviewData = {
        recipe_id: recipeId,
        rating: rating,
        comment: comment,
        user_id: userId // Assign the userId to the user_id field in reviewData
    };
    
    // Clear the form fields
    document.getElementById('rating').value = '';
    document.getElementById('comment').value = '';
    
    // Display alert
    alert("Arvostelu julkaistu.");
    // Optimointi #2
    window.location.reload();
    
    try {
        // Send POST request to add review
        const response = await fetch(`https://funny-cuchufli-a98cc3.netlify.app/.netlify/functions/AddReview`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reviewData),
        });
     
        if (!response.ok) {
            throw new Error('Failed to submit review');
        }
        
        // Fetch and display updated reviews
        fetchAndDisplayReviews();
    } catch (error) {
        console.error('Failed to submit review:', error);
    }
});


fetchAndDisplayReviews();
fetchRecipeDetail();
});
            </script>
           
          
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="plugins/simplebar/simplebar.min.js"></script>
    <script src="js/mono.js"></script>
</body>
</html>
